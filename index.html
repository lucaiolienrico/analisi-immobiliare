<!DOCTYPE html>
<html lang="it" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="description" content="Suite professionale per analisi investimenti immobiliari - Versione 2.0">
    <meta name="theme-color" content="#0f172a">
    <title>InvestPro v2.0 | Suite Analisi Immobiliare Avanzata</title>
    
    <!-- Preload critico -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://www.gstatic.com">
    
    <!-- Font ottimizzato -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- CSS Critical Inline -->
    <style>
        /* Critical CSS per primo paint rapido */
        :root {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #020617;
            --primary: #10b981;
            --primary-hover: #059669;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            --radius-lg: 16px;
            --radius-md: 8px;
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --font-main: 'Inter', sans-serif;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        [data-theme="light"] {
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-input: #f1f5f9;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #cbd5e1;
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            font-family: var(--font-main); 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            font-size: 16px; 
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }
        
        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-card) 25%, rgba(255,255,255,0.05) 50%, var(--bg-card) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-md);
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Loading spinner */
        #app-loader {
            position: fixed;
            inset: 0;
            background: var(--bg-body);
            z-index: 99999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s, visibility 0.5s;
        }
        
        .spinner-ring {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .hidden { display: none !important; }
        
        /* Layout base */
        header { 
            background: rgba(15, 23, 42, 0.98); 
            border-bottom: 1px solid var(--border); 
            padding: 1rem 2rem; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            backdrop-filter: blur(15px);
            transition: var(--transition);
        }
        
        [data-theme="light"] header {
            background: rgba(255, 255, 255, 0.98);
        }
        
        .nav-container { 
            max-width: 1400px; 
            margin: 0 auto; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .logo { 
            font-weight: 900; 
            font-size: 1.5rem; 
            color: var(--primary); 
            display: flex; 
            align-items: center; 
            gap: 0.8rem; 
            text-decoration: none;
            letter-spacing: -0.02em;
        }
        
        .logo span { color: var(--text-main); }
        
        /* Pulsanti base */
        .btn { 
            padding: 0.75rem 1.5rem; 
            border-radius: var(--radius-md); 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.9rem; 
            border: 1px solid var(--border); 
            background: var(--bg-card); 
            color: var(--text-main); 
            display: inline-flex; 
            align-items: center; 
            gap: 0.5rem; 
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover:not(:disabled) { 
            transform: translateY(-2px); 
            box-shadow: var(--shadow-xl);
            border-color: var(--primary);
        }
        
        .btn:active:not(:disabled) { transform: translateY(0); }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary { 
            background: var(--primary); 
            border-color: var(--primary); 
            color: #020617; 
        }
        
        .btn-primary:hover:not(:disabled) { 
            background: var(--primary-hover); 
            border-color: var(--primary-hover);
            box-shadow: 0 10px 30px -10px rgba(16, 185, 129, 0.4);
        }
        
        /* Toast notifications */
        #toast-container { 
            position: fixed; 
            bottom: 30px; 
            right: 30px; 
            z-index: 10000; 
            display: flex; 
            flex-direction: column; 
            gap: 12px;
            max-width: 400px;
            pointer-events: none;
        }
        
        .toast { 
            background: var(--bg-card); 
            border-left: 4px solid var(--primary); 
            color: var(--text-main); 
            padding: 1.25rem; 
            border-radius: 12px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: all;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95rem;
            border: 1px solid var(--border);
        }
        
        .toast.show { transform: translateX(0); }
        .toast.error { border-left-color: var(--danger); }
        .toast.warning { border-left-color: var(--warning); }
        .toast.info { border-left-color: var(--info); }
        
        /* Responsive base */
        @media (max-width: 768px) {
            .nav-container { flex-direction: column; gap: 1rem; }
            header { padding: 1rem; }
        }
    </style>
    
    <!-- Font Awesome async -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload="this.media='all'">
    
    <!-- Manifest per PWA -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiSW52ZXN0UHJvIiwic2hvcnRfbmFtZSI6IkludmVzdFBybyIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMGYxNzJhIiwidGhlbWVfY29sb3IiOiIjMTBiOTgxIn0=">
</head>
<body>

    <!-- App Loader -->
    <div id="app-loader">
        <div class="spinner-ring"></div>
        <p style="margin-top: 1.5rem; font-weight: 700; color: var(--primary); letter-spacing: 0.1em;">INVESTPRO v2.0</p>
        <p style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">Caricamento moduli avanzati...</p>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Header -->
    <header>
        <div class="nav-container">
            <a href="#" class="logo" onclick="app.navigate('dashboard')">
                <i class="fa-solid fa-building-columns"></i>
                <span>InvestPro</span>
                <span style="font-size: 0.6em; background: var(--primary); color: #020617; padding: 2px 8px; border-radius: 20px; margin-left: 8px;">v2.0</span>
            </a>
            
            <div style="display: flex; align-items: center; gap: 1rem;">
                <!-- Theme Toggle -->
                <button class="btn" onclick="app.toggleTheme()" title="Cambia tema" style="padding: 0.6rem;">
                    <i class="fa-solid fa-sun" id="theme-icon"></i>
                </button>
                
                <div id="auth-guest">
                    <button class="btn btn-primary" onclick="app.auth.login()">
                        <i class="fa-brands fa-google"></i> Accedi
                    </button>
                </div>
                
                <div id="auth-user" class="hidden" style="display: flex; align-items: center; gap: 1rem;">
                    <span id="user-badge" class="badge" style="background: var(--primary); color: #020617; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.75rem; font-weight: 800;">FREE</span>
                    <span id="user-email" style="font-weight: 600; font-size: 0.9rem; color: var(--text-muted); max-width: 150px; overflow: hidden; text-overflow: ellipsis;"></span>
                    <button class="btn" onclick="app.auth.logout()" title="Logout" style="padding: 0.6rem;">
                        <i class="fa-solid fa-power-off"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Toolbar -->
    <section class="toolbar" style="max-width: 1400px; margin: 2rem auto 0; padding: 0 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1.5rem;">
        <div style="flex: 1; min-width: 300px;">
            <input type="text" id="project-name" class="project-input" value="Nuova Analisi Asset" 
                   style="background: transparent; border: none; border-bottom: 3px solid var(--border); color: var(--text-main); font-size: 1.75rem; font-weight: 800; width: 100%; padding: 0.5rem 0; letter-spacing: -0.02em; transition: border-color 0.3s; outline: none;"
                   onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'">
            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;" id="project-tags">
                <!-- Tags dinamici -->
            </div>
        </div>
        
        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
            <button class="btn" onclick="app.scenarios.compare()" title="Compara scenari">
                <i class="fa-solid fa-code-compare"></i> Confronta
            </button>
            <button class="btn" onclick="app.export.pdf()" id="btn-pdf">
                <i class="fa-solid fa-file-pdf"></i> PDF
            </button>
            <button class="btn" onclick="app.export.excel()" id="btn-excel">
                <i class="fa-solid fa-file-excel"></i> Excel
            </button>
            <button class="btn" onclick="app.deals.openManager()" id="btn-deals">
                <i class="fa-solid fa-folder-open"></i> Archivio
            </button>
            <button class="btn btn-primary" onclick="app.deals.save()" id="btn-save">
                <i class="fa-solid fa-cloud-arrow-up"></i> Salva
            </button>
        </div>
    </section>

    <!-- Main Dashboard -->
    <main id="main-container" style="padding: 2rem 1.5rem; max-width: 1400px; margin: 0 auto; width: 100%; flex: 1;">
        
        <!-- Quick Stats Bar -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div class="stat-card" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 1.25rem; display: flex; align-items: center; gap: 1rem;">
                <div style="width: 48px; height: 48px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--primary);">
                    <i class="fa-solid fa-euro-sign fa-lg"></i>
                </div>
                <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">Investimento Totale</div>
                    <div style="font-size: 1.25rem; font-weight: 800; color: var(--text-main); margin-top: 0.25rem;" id="quick-total-invest">--</div>
                </div>
            </div>
            
            <div class="stat-card" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 1.25rem; display: flex; align-items: center; gap: 1rem;">
                <div style="width: 48px; height: 48px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--info);">
                    <i class="fa-solid fa-percent fa-lg"></i>
                </div>
                <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">ROI Annuo</div>
                    <div style="font-size: 1.25rem; font-weight: 800; color: var(--primary); margin-top: 0.25rem;" id="quick-roi">--</div>
                </div>
            </div>
            
            <div class="stat-card" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 1.25rem; display: flex; align-items: center; gap: 1rem;">
                <div style="width: 48px; height: 48px; background: rgba(245, 158, 11, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--warning);">
                    <i class="fa-solid fa-wallet fa-lg"></i>
                </div>
                <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">Cashflow Mensile</div>
                    <div style="font-size: 1.25rem; font-weight: 800; color: var(--text-main); margin-top: 0.25rem;" id="quick-cashflow">--</div>
                </div>
            </div>
            
            <div class="stat-card" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 1.25rem; display: flex; align-items: center; gap: 1rem;">
                <div style="width: 48px; height: 48px; background: rgba(239, 68, 68, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--danger);">
                    <i class="fa-solid fa-clock fa-lg"></i>
                </div>
                <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">Break-even</div>
                    <div style="font-size: 1.25rem; font-weight: 800; color: var(--text-main); margin-top: 0.25rem;" id="quick-breakeven">--</div>
                </div>
            </div>
        </div>

        <div class="dashboard-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 2rem;">
            
            <!-- Card 1: Valutazione Operativa -->
            <div class="card" id="card-economics" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 2rem; position: relative; box-shadow: var(--shadow-xl);">
                <div class="card-header" style="margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 1rem;">
                    <div class="step-circle" style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary); color: #020617; font-weight: 900; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0;">1</div>
                    <div>
                        <h3 style="font-size: 1.25rem; font-weight: 800; color: var(--text-main);">Valutazione Operativa</h3>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">Parametri reddituali e fiscali</p>
                    </div>
                </div>

                <!-- Strategy Switcher -->
                <div class="strategy-switch" style="display: flex; background: var(--bg-input); border-radius: var(--radius-md); padding: 4px; border: 1px solid var(--border); margin-bottom: 2rem;">
                    <button class="strategy-btn active" data-mode="rent" onclick="app.mode.set('rent')" 
                            style="flex: 1; padding: 0.75rem; background: transparent; border: none; color: var(--text-muted); font-weight: 700; cursor: pointer; border-radius: 6px; transition: all 0.2s; font-size: 0.9rem;">
                        <i class="fa-solid fa-house-chimney" style="margin-right: 0.5rem;"></i>Messa a Reddito
                    </button>
                    <button class="strategy-btn" data-mode="flip" onclick="app.mode.set('flip')"
                            style="flex: 1; padding: 0.75rem; background: transparent; border: none; color: var(--text-muted); font-weight: 700; cursor: pointer; border-radius: 6px; transition: all 0.2s; font-size: 0.9rem;">
                        <i class="fa-solid fa-handshake" style="margin-right: 0.5rem;"></i>Trading/Flip
                    </button>
                </div>

                <!-- Geolocation Search -->
                <div class="form-group" style="margin-bottom: 1.5rem; position: relative;">
                    <label style="display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">
                        <i class="fa-solid fa-location-dot" style="margin-right: 0.5rem;"></i>Localizzazione Asset
                    </label>
                    <div style="position: relative;">
                        <input type="text" id="geo-search" placeholder="Cerca città (es. Milano, Roma)..." autocomplete="off"
                               style="width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 1rem 1rem 1rem 2.5rem; border-radius: var(--radius-md); font-size: 1rem; transition: var(--transition); outline: none;"
                               oninput="app.geo.search(this.value)">
                        <i class="fa-solid fa-magnifying-glass" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
                    </div>
                    <div id="geo-results" class="dropdown-menu hidden" style="position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); z-index: 150; max-height: 250px; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.4); margin-top: 0.5rem;"></div>
                </div>

                <!-- RENT Section -->
                <div id="section-rent">
                    <div class="input-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label style="display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">ADR Medio (€/notte)</label>
                            <input type="number" id="adr" value="180" min="0" step="5"
                                   style="width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 0.875rem; border-radius: var(--radius-md); font-size: 1rem; transition: var(--transition);"
                                   onchange="app.calc.update()">
                        </div>
                        <div class="form-group">
                            <label style="display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Tassa Soggiorno (€)</label>
                            <input type="number" id="city-tax" value="2.00" step="0.5" min="0"
                                   style="width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 0.875rem; border-radius: var(--radius-md); font-size: 1rem; transition: var(--transition);"
                                   onchange="app.calc.update()">
                        </div>
                    </div>

                    <!-- Tax Regime -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Regime Fiscale</label>
                        <div class="tax-switcher" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; background: var(--bg-input); padding: 4px; border-radius: var(--radius-md); border: 1px solid var(--border);">
                            <button class="btn-tax active" data-tax="21" onclick="app.calc.setTax(21, this)" style="background: var(--primary); border: 1px solid var(--primary); color: #020617; padding: 0.75rem 0.5rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 700; transition: all 0.2s; text-align: center;">Cedolare 21%</button>
                            <button class="btn-tax" data-tax="26" onclick="app.calc.setTax(26, this)" style="background: transparent; border: 1px solid transparent; color: var(--text-muted); padding: 0.75rem 0.5rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 700; transition: all 0.2s; text-align: center;">Cedolare 26%</button>
                            <button class="btn-tax" data-tax="28" onclick="app.calc.setTax(28, this)" style="background: transparent; border: 1px solid transparent; color: var(--text-muted); padding: 0.75rem 0.5rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 700; transition: all 0.2s; text-align: center;">Società 28%</button>
                        </div>
                    </div>

                    <div class="input-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label style="display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Commissioni OTA (%)</label>
                            <input type="number" id="portal-comm" value="18" min="0" max="50" step="1"
                                   style="width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 0.875rem; border-radius: var(--radius-md); font-size: 1rem;"
                                   onchange="app.calc.update()">
                        </div>
                        <div class="form-group">
                            <label style="display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Aliquota Fiscale (%)</label>
                            <input type="number" id="tax-rate" value="21" min="0" max="100" step="1"
                                   style="width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 0.875rem; border-radius: var(--radius-md); font-size: 1rem;"
                                   oninput="app.calc.highlightCustomTax(); app.calc.update()">
                        </div>
                    </div>

                    <div class="input-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label style="display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Costi Variabili/Notte (€)</label>
                            <input type="number" id="var-costs" value="30" min="0" step="5"
                                   style="width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 0.875rem; border-radius: var(--radius-md); font-size: 1rem;"
                                   onchange="app.calc.update()">
                        </div>
                        <div class="form-group">
                            <label style="display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Occupazione Media (%)</label>
                            <input type="number" id="occ" value="75" min="0" max="100" step="5"
                                   style="width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 0.875rem; border-radius: var(--radius-md); font-size: 1rem;"
                                   onchange="app.calc.update()">
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Costi Fissi Mensili (€)</label>
                        <input type="number" id="fixed-costs" value="1000" min="0" step="50"
                               style="width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 0.875rem; border-radius: var(--radius-md); font-size: 1rem;"
                               onchange="app.calc.update()">
                    </div>

                    <!-- KPI Rent -->
                    <div style="display: grid; gap: 1rem;">
                        <div class="kpi-container" style="background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 1.25rem; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.85rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase;">Utile Netto / Notte</span>
                            <span style="font-size: 1.5rem; font-weight: 800; color: var(--primary); font-variant-numeric: tabular-nums;" id="res-net-night">--</span>
                        </div>
                        <div class="kpi-container" style="background: rgba(16, 185, 129, 0.1); border: 1px solid var(--primary); border-radius: var(--radius-md); padding: 1.25rem; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.85rem; color: var(--primary); font-weight: 700; text-transform: uppercase;">MOL Mensile</span>
                            <span style="font-size: 1.5rem; font-weight: 800; color: var(--primary); font-variant-numeric: tabular-nums;" id="res-mol-month">--</span>
                        </div>
                    </div>
                </div>

                <!-- FLIP Section (Hidden by default) -->
                <div id="section-flip" class="hidden">
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Prezzo Rivendita Stimato (€)</label>
                        <input type="number" id="resale-price" value="580000" min="0" step="1000"
                               style="width: 100%; background: var(--bg-input); border: 2px solid var(--primary); color: var(--text-main); padding: 0.875rem; border-radius: var(--radius-md); font-size: 1rem; font-weight: 700;"
                               onchange="app.calc.update()">
                    </div>

                    <div class="input-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label style="display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Durata Operazione (mesi)</label>
                            <input type="number" id="flip-months" value="6" min="1" max="60" step="1"
                                   style="width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 0.875rem; border-radius: var(--radius-md); font-size: 1rem;"
                                   onchange="app.calc.update()">
                        </div>
                        <div class="form-group">
                            <label style="display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Commissioni Agenzia (%)</label>
                            <input type="number" id="flip-agency" value="3" min="0" max="10" step="0.5"
                                   style="width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 0.875rem; border-radius: var(--radius-md); font-size: 1rem;"
                                   onchange="app.calc.update()">
                        </div>
                    </div>

                    <div class="input-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="form-group">
                            <label style="display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Spese Condominiali/mese (€)</label>
                            <input type="number" id="flip-holding-extra" value="200" min="0" step="10"
                                   style="width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 0.875rem; border-radius: var(--radius-md); font-size: 1rem;"
                                   onchange="app.calc.update()">
                        </div>
                        <div class="form-group">
                            <label style="display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Tasse su Utile (%)</label>
                            <input type="number" id="flip-tax" value="26" min="0" max="100" step="1"
                                   style="width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 0.875rem; border-radius: var(--radius-md); font-size: 1rem;"
                                   onchange="app.calc.update()">
                        </div>
                    </div>

                    <!-- KPI Flip -->
                    <div style="display: grid; gap: 1rem;">
                        <div class="kpi-container" style="background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 1.25rem; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.85rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase;">Utile Netto Operazione</span>
                            <span style="font-size: 1.5rem; font-weight: 800; color: var(--primary); font-variant-numeric: tabular-nums;" id="res-flip-profit">--</span>
                        </div>
                        <div class="kpi-container" style="background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warning); border-radius: var(--radius-md); padding: 1.25rem; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.85rem; color: var(--warning); font-weight: 700; text-transform: uppercase;">ROI Totale</span>
                            <span style="font-size: 1.5rem; font-weight: 800; color: var(--warning); font-variant-numeric: tabular-nums;" id="res-flip-roi">--</span>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div style="margin-top: 2rem; border-top: 1px solid var(--border); padding-top: 2rem;">
                    <div class="chart-toggle-container" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem;">
                        <button class="chart-toggle active" onclick="app.chart.switch('profit')" id="btn-chart-profit" style="background: transparent; border: none; color: var(--text-main); font-weight: 700; cursor: pointer; padding-bottom: 0.5rem; border-bottom: 2px solid var(--primary); transition: all 0.3s;">
                            Distribuzione Ricavi
                        </button>
                        <button class="chart-toggle" onclick="app.chart.switch('proj')" id="btn-chart-proj" style="background: transparent; border: none; color: var(--text-muted); font-weight: 700; cursor: pointer; padding-bottom: 0.5rem; border-bottom: 2px solid transparent; transition: all 0.3s;">
                            Proiezione Patrimoniale
                        </button>
                    </div>

                    <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem; display: none;" id="appreciation-control">
                        <div style="width: 140px;">
                            <label style="font-size: 0.7rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 0.25rem;">Rivalutazione Annua %</label>
                            <input type="number" id="appreciation" value="2.0" step="0.5" min="-10" max="20"
                                   style="width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 0.5rem; border-radius: var(--radius-md); font-size: 0.9rem;"
                                   onchange="app.chart.updateProjection()">
                        </div>
                    </div>

                    <div class="chart-wrapper" style="position: relative; height: 300px; width: 100%;">
                        <div id="view-profit" class="chart-view" style="width: 100%; height: 100%;">
                            <canvas id="profitChart"></canvas>
                        </div>
                        <div id="view-proj" class="chart-view hidden" style="width: 100%; height: 100%;">
                            <canvas id="projectionChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Sensitivity Analysis -->
                <div id="sensitivity-rent" style="margin-top: 2rem; border-top: 1px solid var(--border); padding-top: 1.5rem;">
                    <h4 style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 1rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em;">
                        <i class="fa-solid fa-chart-line" style="margin-right: 0.5rem;"></i>Analisi Sensibilità Occupazione
                    </h4>
                    <div style="display: grid; gap: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(239, 68, 68, 0.05); border-radius: var(--radius-md); border-left: 3px solid var(--danger);">
                            <span style="font-size: 0.9rem; color: var(--danger); font-weight: 600;">Scenario Pesimistico (50%)</span>
                            <span id="sens-50" style="font-weight: 800; font-variant-numeric: tabular-nums;">--</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(245, 158, 11, 0.05); border-radius: var(--radius-md); border-left: 3px solid var(--warning);">
                            <span style="font-size: 0.9rem; color: var(--warning); font-weight: 600;">Scenario Moderato (65%)</span>
                            <span id="sens-65" style="font-weight: 800; font-variant-numeric: tabular-nums;">--</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(16, 185, 129, 0.05); border-radius: var(--radius-md); border-left: 3px solid var(--primary);">
                            <span style="font-size: 0.9rem; color: var(--primary); font-weight: 600;">Scenario Ottimistico (85%)</span>
                            <span id="sens-85" style="font-weight: 800; font-variant-numeric: tabular-nums;">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 2: Struttura Debito (PRO) -->
            <div class="card" id="card-pro" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 2rem; position: relative; box-shadow: var(--shadow-xl);">
                
                <!-- Lock Overlay -->
                <div class="overlay-lock" id="pro-lock" style="position: absolute; inset: 0; z-index: 30; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(8px); border-radius: var(--radius-lg); text-align: center; padding: 3rem;">
                    <div style="width: 80px; height: 80px; background: rgba(16, 185, 129, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem;">
                        <i class="fa-solid fa-lock" style="font-size: 2rem; color: var(--primary);"></i>
                    </div>
                    <h2 style="margin-bottom: 0.75rem; font-weight: 800; font-size: 1.5rem; color: var(--text-main);">Funzionalità PRO</h2>
                    <p style="color: var(--text-muted); margin-bottom: 2rem; max-width: 300px; font-size: 0.95rem; line-height: 1.6;">
                        Sblocca il calcolo ammortamento dinamico, analisi equity e cashflow post-debito avanzato.
                    </p>
                    <button class="btn btn-primary" onclick="app.upgrade.showModal()" style="padding: 1rem 2rem; font-size: 1rem;">
                        <i class="fa-solid fa-crown" style="margin-right: 0.5rem;"></i>Upgrade a PRO
                    </button>
                    <p style="margin-top: 1rem; font-size: 0.8rem; color: var(--text-muted);">9,90€ una tantum • Accesso permanente</p>
                </div>

                <div class="card-header" style="margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 1rem;">
                    <div class="step-circle" style="width: 40px; height: 40px; border-radius: 50%; background: white; color: #020617; font-weight: 900; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0;">2</div>
                    <div>
                        <h3 style="font-size: 1.25rem; font-weight: 800; color: var(--text-main);">Struttura Finanziaria</h3>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">Mutuo, equity e piano ammortamento</p>
                    </div>
                </div>

                <div class="pro-content">
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Prezzo d'Acquisto (€)</label>
                        <input type="number" id="price" value="450000" min="0" step="1000"
                               style="width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 0.875rem; border-radius: var(--radius-md); font-size: 1rem;"
                               onchange="app.calc.update()">
                    </div>

                    <div class="input-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label style="display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Capex/Ristrutturazione (€)</label>
                            <input type="number" id="reno" value="50000" min="0" step="1000"
                                   style="width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 0.875rem; border-radius: var(--radius-md); font-size: 1rem;"
                                   onchange="app.calc.update()">
                        </div>
                        <div class="form-group">
                            <label style="display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Notaio & Oneri (€)</label>
                            <input type="number" id="closing" value="20000" min="0" step="500"
                                   style="width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 0.875rem; border-radius: var(--radius-md); font-size: 1rem;"
                                   onchange="app.calc.update()">
                        </div>
                    </div>

                    <div class="input-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="form-group">
                            <label style="display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">LTV Mutuo (%)</label>
                            <input type="number" id="ltv" value="80" min="0" max="100" step="5"
                                   style="width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 0.875rem; border-radius: var(--radius-md); font-size: 1rem;"
                                   onchange="app.calc.update()">
                        </div>
                        <div class="form-group">
                            <label style="display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Tasso Interesse Annuo (%)</label>
                            <input type="number" id="rate" value="4.0" min="0" max="20" step="0.1"
                                   style="width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 0.875rem; border-radius: var(--radius-md); font-size: 1rem;"
                                   onchange="app.calc.update()">
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 2rem;">
                        <label style="display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">Durata Finanziamento (anni)</label>
                        <input type="number" id="years" value="25" min="1" max="40" step="1"
                               style="width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 0.875rem; border-radius: var(--radius-md); font-size: 1rem;"
                               onchange="app.calc.update()">
                    </div>

                    <!-- KPI Debito -->
                    <div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="kpi-container" style="background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 1.25rem; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.85rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase;">Rata Mensile Stimata</span>
                            <span style="font-size: 1.5rem; font-weight: 800; color: var(--text-main); font-variant-numeric: tabular-nums;" id="res-mortgage">--</span>
                        </div>
                        
                        <div id="kpi-rent-debt" style="display: grid; gap: 1rem;">
                            <div class="kpi-container" style="background: var(--primary); border: none; border-radius: var(--radius-md); padding: 1.25rem; display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.85rem; color: #020617; font-weight: 700; text-transform: uppercase;">Cashflow Netto Post-Debito</span>
                                <span style="font-size: 1.5rem; font-weight: 800; color: #020617; font-variant-numeric: tabular-nums;" id="res-cashflow">--</span>
                            </div>
                        </div>

                        <div id="kpi-flip-debt" class="hidden" style="display: grid; gap: 1rem;">
                            <div class="kpi-container" style="background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warning); border-radius: var(--radius-md); padding: 1.25rem; display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.85rem; color: var(--warning); font-weight: 700; text-transform: uppercase;">Costi Holding Totali</span>
                                <span style="font-size: 1.5rem; font-weight: 800; color: var(--warning); font-variant-numeric: tabular-nums;" id="res-holding-costs">--</span>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="mini-kpi" style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 1rem;">
                            <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; margin-bottom: 0.25rem;">Equity Necessaria</div>
                            <div style="font-size: 1.1rem; font-weight: 800; color: var(--text-main);" id="res-downpayment">--</div>
                        </div>
                        <div class="mini-kpi" style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 1rem;">
                            <div style="font-size: 0.7rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; margin-bottom: 0.25rem;">Interessi Totali</div>
                            <div style="font-size: 1.1rem; font-weight: 800; color: var(--text-main);" id="res-total-interest">--</div>
                        </div>
                    </div>

                    <button class="btn" onclick="app.calc.showAmortization()" style="width: 100%; justify-content: center; background: rgba(255,255,255,0.05); border-style: dashed;">
                        <i class="fa-solid fa-table-list"></i> Visualizza Piano Ammortamento
                    </button>
                </div>
            </div>
        </div>

        <!-- Scenario Comparison Section (Hidden by default) -->
        <div id="scenario-comparison" class="hidden" style="margin-top: 3rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow-xl);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h3 style="font-size: 1.25rem; font-weight: 800;"><i class="fa-solid fa-code-compare" style="margin-right: 0.75rem; color: var(--primary);"></i>Confronto Scenari</h3>
                <button class="btn" onclick="app.scenarios.close()"><i class="fa-solid fa-xmark"></i> Chiudi</button>
            </div>
            <div id="scenario-content" style="overflow-x: auto;">
                <!-- Dinamically populated -->
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer style="background: var(--bg-input); padding: 4rem 2rem 2rem; border-top: 1px solid var(--border); margin-top: 4rem;">
        <div style="max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 3rem; margin-bottom: 3rem;">
            <div>
                <span style="font-weight: 900; color: var(--text-main); font-size: 1.5rem; display: block; margin-bottom: 1rem; letter-spacing: -0.02em;">INVESTPRO</span>
                <p style="color: var(--text-muted); line-height: 1.7; font-size: 0.95rem;">Suite avanzata per la modellazione finanziaria immobiliare. Analisi precise, decisioni intelligenti.</p>
            </div>
            <div>
                <h5 style="color: var(--text-main); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.1em; margin-bottom: 1.5rem; font-weight: 800;">Strumenti</h5>
                <ul style="list-style: none;">
                    <li style="margin-bottom: 0.75rem;"><a href="#" style="color: var(--text-muted); text-decoration: none; font-size: 0.95rem; transition: color 0.2s;">Simulatore ROI</a></li>
                    <li style="margin-bottom: 0.75rem;"><a href="#" style="color: var(--text-muted); text-decoration: none; font-size: 0.95rem; transition: color 0.2s;">Analisi Cashflow</a></li>
                    <li style="margin-bottom: 0.75rem;"><a href="#" style="color: var(--text-muted); text-decoration: none; font-size: 0.95rem; transition: color 0.2s;">Piano Ammortamento</a></li>
                </ul>
            </div>
            <div>
                <h5 style="color: var(--text-main); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.1em; margin-bottom: 1.5rem; font-weight: 800;">Supporto</h5>
                <ul style="list-style: none;">
                    <li style="margin-bottom: 0.75rem;"><a href="#" style="color: var(--text-muted); text-decoration: none; font-size: 0.95rem; transition: color 0.2s;">Documentazione</a></li>
                    <li style="margin-bottom: 0.75rem;"><a href="#" style="color: var(--text-muted); text-decoration: none; font-size: 0.95rem; transition: color 0.2s;">API Reference</a></li>
                    <li style="margin-bottom: 0.75rem;"><a href="#" style="color: var(--text-muted); text-decoration: none; font-size: 0.95rem; transition: color 0.2s;">Contattaci</a></li>
                </ul>
            </div>
        </div>
        <div style="max-width: 1400px; margin: 0 auto; padding-top: 2rem; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; font-size: 0.85rem; color: var(--text-muted);">
            <div>&copy; 2024 InvestPro Professional Suite. Tutti i diritti riservati.</div>
            <div style="display: flex; gap: 1.5rem;">
                <a href="#" style="color: var(--text-muted);"><i class="fa-brands fa-linkedin fa-lg"></i></a>
                <a href="#" style="color: var(--text-muted);"><i class="fa-brands fa-instagram fa-lg"></i></a>
                <a href="#" style="color: var(--text-muted);"><i class="fa-brands fa-twitter fa-lg"></i></a>
            </div>
        </div>
    </footer>

    <!-- Modals -->
    <!-- Login Modal -->
    <div id="modal-login" class="modal-backdrop" style="position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s;">
        <div class="modal-panel" style="background: var(--bg-card); border: 1px solid var(--border); width: 90%; max-width: 450px; border-radius: 24px; padding: 3rem; text-align: center; transform: scale(0.9); transition: transform 0.3s;">
            <div style="width: 70px; height: 70px; background: rgba(16, 185, 129, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                <i class="fa-solid fa-fingerprint" style="font-size: 2rem; color: var(--primary);"></i>
            </div>
            <h2 style="margin-bottom: 0.75rem; font-weight: 800; color: var(--text-main);">Accesso Riservato</h2>
            <p style="color: var(--text-muted); margin-bottom: 2rem; font-size: 0.95rem;">Sincronizza i tuoi deal su cloud sicuro e accedi alle funzionalità PRO.</p>
            
            <button class="btn btn-primary" onclick="app.auth.loginGoogle()" style="width: 100%; justify-content: center; margin-bottom: 1rem; padding: 1rem;">
                <i class="fa-brands fa-google" style="margin-right: 0.5rem;"></i>Continua con Google
            </button>
            
            <button class="btn" onclick="app.ui.closeModal('modal-login')" style="width: 100%; justify-content: center;">
                Annulla
            </button>
        </div>
    </div>

    <!-- Deals Manager Modal -->
    <div id="modal-deals" class="modal-backdrop" style="position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s;">
        <div class="modal-panel" style="background: var(--bg-card); border: 1px solid var(--border); width: 95%; max-width: 800px; border-radius: 24px; padding: 2rem; max-height: 80vh; overflow-y: auto; transform: scale(0.9); transition: transform 0.3s;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="font-weight: 800; color: var(--text-main);">Archivio Deal</h2>
                <button class="btn" onclick="app.ui.closeModal('modal-deals')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="deals-list" style="display: grid; gap: 0.75rem;">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Amortization Modal -->
    <div id="modal-amortization" class="modal-backdrop" style="position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s;">
        <div class="modal-panel" style="background: var(--bg-card); border: 1px solid var(--border); width: 95%; max-width: 900px; border-radius: 24px; padding: 2rem; max-height: 85vh; overflow-y: auto; transform: scale(0.9); transition: transform 0.3s;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="font-weight: 800; color: var(--text-main);">Piano Ammortamento Francese</h2>
                <button class="btn" onclick="app.ui.closeModal('modal-amortization')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div style="overflow-x: auto;">
                <table class="amortization-table" style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border);">
                            <th style="text-align: left; padding: 1rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Anno</th>
                            <th style="text-align: right; padding: 1rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Quota Interessi</th>
                            <th style="text-align: right; padding: 1rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Quota Capitale</th>
                            <th style="text-align: right; padding: 1rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Debito Residuo</th>
                        </tr>
                    </thead>
                    <tbody id="amortization-body">
                        <!-- Populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Upgrade Modal -->
    <div id="modal-upgrade" class="modal-backdrop" style="position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s;">
        <div class="modal-panel" style="background: var(--bg-card); border: 1px solid var(--primary); width: 90%; max-width: 500px; border-radius: 24px; padding: 3rem; text-align: center; transform: scale(0.9); transition: transform 0.3s; box-shadow: 0 0 60px rgba(16, 185, 129, 0.2);">
            <div style="width: 80px; height: 80px; background: rgba(16, 185, 129, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; border: 2px solid var(--primary);">
                <i class="fa-solid fa-crown" style="font-size: 2rem; color: var(--primary);"></i>
            </div>
            <h2 style="margin-bottom: 0.5rem; font-weight: 800; color: var(--text-main); font-size: 1.75rem;">Passa a PRO</h2>
            <p style="color: var(--text-muted); margin-bottom: 2rem; font-size: 1rem;">Sblocca tutte le funzionalità avanzate</p>
            
            <div style="text-align: left; margin-bottom: 2rem; background: rgba(255,255,255,0.03); border-radius: 12px; padding: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; color: var(--text-main);">
                    <i class="fa-solid fa-check" style="color: var(--primary);"></i>
                    <span>Calcolo ammortamento dinamico</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; color: var(--text-main);">
                    <i class="fa-solid fa-check" style="color: var(--primary);"></i>
                    <span>Analisi equity e leverage</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; color: var(--text-main);">
                    <i class="fa-solid fa-check" style="color: var(--primary);"></i>
                    <span>Cashflow post-debito avanzato</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.75rem; color: var(--text-main);">
                    <i class="fa-solid fa-check" style="color: var(--primary);"></i>
                    <span>Export Excel e PDF illimitati</span>
                </div>
            </div>
            
            <div style="font-size: 2.5rem; font-weight: 900; color: var(--primary); margin-bottom: 0.5rem;">9,90€</div>
            <div style="color: var(--text-muted); margin-bottom: 2rem; font-size: 0.9rem;">Pagamento unico • Accesso permanente</div>
            
            <button class="btn btn-primary" onclick="app.upgrade.purchase()" style="width: 100%; justify-content: center; padding: 1rem; font-size: 1.1rem; margin-bottom: 1rem;">
                <i class="fa-solid fa-lock-open" style="margin-right: 0.5rem;"></i>Sblocca Ora
            </button>
            
            <button class="btn" onclick="app.ui.closeModal('modal-upgrade')" style="width: 100%; justify-content: center;">
                Magari più tardi
            </button>
        </div>
    </div>

    <!-- Admin Trigger -->
    <button id="admin-trigger" class="btn hidden" onclick="app.admin.openConsole()" style="position: fixed; bottom: 30px; left: 30px; z-index: 200; background: var(--warning); color: #020617; font-weight: 800; border: none; box-shadow: 0 0 30px rgba(245, 158, 11, 0.4); padding: 1rem 1.5rem; border-radius: 50px;">
        <i class="fa-solid fa-shield-halved"></i> Admin
    </button>

    <!-- Lazy loaded scripts -->
    <script>
        // Configuration and State Management
        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyDiGDvR2yXm0DE7vlJNGrIPQB0G-ntLHc0",
                authDomain: "analisimmobiliare-3b4a7.firebaseapp.com",
                projectId: "analisimmobiliare-3b4a7",
                storageBucket: "analisimmobiliare-3b4a7.appspot.com",
                messagingSenderId: "29979040948",
                appId: "1:29979040948:web:597ea331e06567d8d50be1"
            },
            adminEmail: "lucaiolienrico1@gmail.com",
            stripeLink: "https://buy.stripe.com/test_4gM8wP85i5I0flc0PygjC01",
            version: "2.0.0"
        };

        // City Database with extended data
        const CITY_DB = [
            { l: "Roma (RM)", v: 6.0, k: "roma", region: "Lazio", population: 2800000 },
            { l: "Milano (MI)", v: 4.5, k: "milano", region: "Lombardia", population: 1350000 },
            { l: "Venezia (VE)", v: 5.0, k: "venezia", region: "Veneto", population: 260000 },
            { l: "Firenze (FI)", v: 5.5, k: "firenze", region: "Toscana", population: 380000 },
            { l: "Napoli (NA)", v: 4.5, k: "napoli", region: "Campania", population: 960000 },
            { l: "Torino (TO)", v: 2.8, k: "torino", region: "Piemonte", population: 870000 },
            { l: "Bologna (BO)", v: 3.0, k: "bologna", region: "Emilia-Romagna", population: 390000 },
            { l: "Verona (VR)", v: 3.5, k: "verona", region: "Veneto", population: 260000 },
            { l: "Genova (GE)", v: 2.5, k: "genova", region: "Liguria", population: 580000 },
            { l: "Palermo (PA)", v: 2.0, k: "palermo", region: "Sicilia", population: 670000 },
            { l: "Bari (BA)", v: 2.5, k: "bari", region: "Puglia", population: 320000 },
            { l: "Catania (CT)", v: 2.0, k: "catania", region: "Sicilia", population: 310000 }
        ];

        // State Manager
        class StateManager {
            constructor() {
                this.state = {
                    user: null,
                    isPro: false,
                    currentDocId: null,
                    mode: 'rent',
                    theme: localStorage.getItem('theme') || 'dark',
                    charts: {},
                    lastSaved: null,
                    scenarios: []
                };
                this.listeners = new Map();
                this.loadTheme();
            }

            get(key) {
                return key.split('.').reduce((obj, k) => obj?.[k], this.state);
            }

            set(key, value) {
                const keys = key.split('.');
                const last = keys.pop();
                const target = keys.reduce((obj, k) => {
                    if (!obj[k]) obj[k] = {};
                    return obj[k];
                }, this.state);
                
                const oldValue = target[last];
                target[last] = value;
                
                if (oldValue !== value) {
                    this.notify(key, value, oldValue);
                }
                
                // Persist critical state
                if (key === 'theme') localStorage.setItem('theme', value);
            }

            subscribe(key, callback) {
                if (!this.listeners.has(key)) this.listeners.set(key, new Set());
                this.listeners.get(key).add(callback);
                return () => this.listeners.get(key).delete(callback);
            }

            notify(key, newVal, oldVal) {
                if (this.listeners.has(key)) {
                    this.listeners.get(key).forEach(cb => cb(newVal, oldVal));
                }
                // Notify wildcard listeners
                const parentKey = key.split('.').slice(0, -1).join('.');
                if (parentKey && this.listeners.has(parentKey + '.*')) {
                    this.listeners.get(parentKey + '.*').forEach(cb => cb(newVal, oldVal, key));
                }
            }

            loadTheme() {
                document.documentElement.setAttribute('data-theme', this.state.theme);
                const icon = document.getElementById('theme-icon');
                if (icon) icon.className = this.state.theme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
            }

            toggleTheme() {
                const newTheme = this.state.theme === 'dark' ? 'light' : 'dark';
                this.set('theme', newTheme);
                document.documentElement.setAttribute('data-theme', newTheme);
                const icon = document.getElementById('theme-icon');
                if (icon) icon.className = newTheme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
                app.toast.show(`Tema ${newTheme === 'dark' ? 'scuro' : 'chiaro'} attivato`, 'info');
            }
        }

        // Main Application
        const app = {
            state: new StateManager(),
            
            init: async () => {
                try {
                    // Initialize Firebase lazily
                    await app.loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js');
                    await app.loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js');
                    await app.loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js');
                    
                    if (!firebase.apps.length) {
                        firebase.initializeApp(CONFIG.firebase);
                    }
                    
                    app.services = {
                        auth: firebase.auth(),
                        db: firebase.firestore()
                    };
                    
                    // Setup auth state listener
                    app.services.auth.onAuthStateChanged(app.auth.handleStateChange);
                    
                    // Load Chart.js
                    await app.loadScript('https://cdn.jsdelivr.net/npm/chart.js');
                    app.chart.init();
                    
                    // Load export libraries on demand
                    app.export.init();
                    
                    // Setup UI
                    app.setupEventListeners();
                    app.calc.update();
                    app.restoreDraft();
                    
                    // Hide loader
                    setTimeout(() => {
                        document.getElementById('app-loader').style.opacity = '0';
                        setTimeout(() => document.getElementById('app-loader').remove(), 500);
                    }, 500);
                    
                } catch (error) {
                    console.error('Init error:', error);
                    app.toast.show('Errore inizializzazione app', 'error');
                }
            },

            loadScript: (src) => {
                return new Promise((resolve, reject) => {
                    if (document.querySelector(`script[src="${src}"]`)) {
                        resolve();
                        return;
                    }
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = reject;
                    script.async = true;
                    document.head.appendChild(script);
                });
            },

            setupEventListeners: () => {
                // Input debouncing
                let timeout;
                document.querySelectorAll('input[type="number"]').forEach(input => {
                    input.addEventListener('input', () => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => {
                            app.calc.update();
                            app.saveDraft();
                        }, 300);
                    });
                });

                // Close dropdowns on outside click
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#geo-search')) {
                        document.getElementById('geo-results').classList.add('hidden');
                    }
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === 's') {
                            e.preventDefault();
                            app.deals.save();
                        }
                    }
                });
            },

            // UI Utilities
            ui: {
                openModal: (id) => {
                    const modal = document.getElementById(id);
                    modal.style.opacity = '1';
                    modal.style.pointerEvents = 'auto';
                    modal.querySelector('.modal-panel').style.transform = 'scale(1)';
                },

                closeModal: (id) => {
                    const modal = document.getElementById(id);
                    modal.style.opacity = '0';
                    modal.style.pointerEvents = 'none';
                    modal.querySelector('.modal-panel').style.transform = 'scale(0.9)';
                },

                toggleLoading: (show, text = 'Caricamento...') => {
                    // Implementation for global loading overlay if needed
                }
            },

            // Toast Notification System
            toast: {
                queue: [],
                showing: false,

                show: (message, type = 'info', duration = 3500) => {
                    const container = document.getElementById('toast-container');
                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    
                    const icons = {
                        success: 'fa-circle-check',
                        error: 'fa-circle-xmark',
                        warning: 'fa-triangle-exclamation',
                        info: 'fa-circle-info'
                    };
                    
                    toast.innerHTML = `
                        <i class="fa-solid ${icons[type] || icons.info}" style="font-size: 1.25rem; ${type === 'success' ? 'color: var(--primary)' : type === 'error' ? 'color: var(--danger)' : type === 'warning' ? 'color: var(--warning)' : 'color: var(--info)'}"></i>
                        <span style="flex: 1;">${message}</span>
                    `;
                    
                    container.appendChild(toast);
                    
                    // Trigger animation
                    requestAnimationFrame(() => toast.classList.add('show'));
                    
                    setTimeout(() => {
                        toast.classList.remove('show');
                        setTimeout(() => toast.remove(), 500);
                    }, duration);
                }
            },

            // Authentication
            auth: {
                handleStateChange: async (user) => {
                    app.state.set('user', user);
                    
                    const guestEl = document.getElementById('auth-guest');
                    const userEl = document.getElementById('auth-user');
                    const adminBtn = document.getElementById('admin-trigger');
                    
                    if (user) {
                        guestEl.classList.add('hidden');
                        userEl.classList.remove('hidden');
                        document.getElementById('user-email').textContent = user.email;
                        
                        // Check admin
                        if (user.email.toLowerCase() === CONFIG.adminEmail.toLowerCase()) {
                            adminBtn.classList.remove('hidden');
                        }
                        
                        // Check PRO status
                        try {
                            const doc = await app.services.db.collection('users').doc(user.uid).get();
                            if (doc.exists) {
                                app.state.set('isPro', doc.data().plan === 'pro');
                                app.updateProUI();
                            } else {
                                await app.services.db.collection('users').doc(user.uid).set({
                                    email: user.email,
                                    plan: 'free',
                                    joined: new Date(),
                                    version: CONFIG.version
                                });
                            }
                        } catch (e) {
                            console.error('Error checking user plan:', e);
                        }
                    } else {
                        guestEl.classList.remove('hidden');
                        userEl.classList.add('hidden');
                        adminBtn.classList.add('hidden');
                        app.state.set('isPro', false);
                        app.updateProUI();
                    }
                },

                loginGoogle: async () => {
                    try {
                        const provider = new firebase.auth.GoogleAuthProvider();
                        await app.services.auth.signInWithPopup(provider);
                        app.ui.closeModal('modal-login');
                        app.toast.show('Accesso effettuato con successo', 'success');
                    } catch (error) {
                        app.toast.show('Errore accesso: ' + error.message, 'error');
                    }
                },

                logout: async () => {
                    try {
                        await app.services.auth.signOut();
                        app.toast.show('Logout effettuato', 'info');
                    } catch (error) {
                        app.toast.show('Errore logout', 'error');
                    }
                },

                login: () => {
                    app.ui.openModal('modal-login');
                }
            },

            updateProUI: () => {
                const isPro = app.state.get('isPro');
                const lockOverlay = document.getElementById('pro-lock');
                const badge = document.getElementById('user-badge');
                
                if (isPro) {
                    lockOverlay.style.display = 'none';
                    badge.textContent = 'PRO';
                    badge.style.background = 'var(--primary)';
                } else {
                    lockOverlay.style.display = 'flex';
                    badge.textContent = 'FREE';
                    badge.style.background = 'var(--text-muted)';
                }
            },

            // Mode Management
            mode: {
                set: (mode) => {
                    app.state.set('mode', mode);
                    
                    // Update buttons
                    document.querySelectorAll('.strategy-btn').forEach(btn => {
                        const isActive = btn.dataset.mode === mode;
                        btn.classList.toggle('active', isActive);
                        btn.style.background = isActive ? 'var(--primary)' : 'transparent';
                        btn.style.color = isActive ? '#020617' : 'var(--text-muted)';
                    });
                    
                    // Toggle sections
                    document.getElementById('section-rent').classList.toggle('hidden', mode !== 'rent');
                    document.getElementById('section-flip').classList.toggle('hidden', mode !== 'flip');
                    document.getElementById('sensitivity-rent').classList.toggle('hidden', mode !== 'rent');
                    
                    // Toggle debt KPIs
                    document.getElementById('kpi-rent-debt').classList.toggle('hidden', mode !== 'rent');
                    document.getElementById('kpi-flip-debt').classList.toggle('hidden', mode !== 'flip');
                    
                    // Update charts
                    if (mode === 'flip') {
                        app.chart.switch('profit');
                    }
                    
                    app.calc.update();
                }
            },

            // Geolocation
            geo: {
                search: debounce((query) => {
                    const list = document.getElementById('geo-results');
                    if (!query || query.length < 2) {
                        list.classList.add('hidden');
                        return;
                    }

                    const q = query.toLowerCase().trim();
                    const results = CITY_DB.filter(c => 
                        c.k.includes(q) || c.l.toLowerCase().includes(q) || c.region.toLowerCase().includes(q)
                    ).slice(0, 5);

                    list.innerHTML = '';
                    if (results.length === 0) {
                        list.classList.add('hidden');
                        return;
                    }

                    list.classList.remove('hidden');
                    results.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'dropdown-item';
                        div.style.cssText = 'padding: 1rem; cursor: pointer; border-bottom: 1px solid var(--border); color: var(--text-muted); transition: all 0.2s; display: flex; align-items: center; gap: 0.75rem;';
                        div.innerHTML = `
                            <i class="fa-solid fa-location-dot" style="color: var(--primary);"></i>
                            <div>
                                <div style="font-weight: 600; color: var(--text-main);">${item.l}</div>
                                <div style="font-size: 0.8rem; opacity: 0.7;">${item.region} • Tassa €${item.v.toFixed(2)}</div>
                            </div>
                        `;
                        
                        div.onmouseenter = () => {
                            div.style.background = 'var(--primary)';
                            div.style.color = '#020617';
                        };
                        div.onmouseleave = () => {
                            div.style.background = 'transparent';
                            div.style.color = 'var(--text-muted)';
                        };
                        
                        div.onclick = () => {
                            document.getElementById('geo-search').value = item.l;
                            document.getElementById('city-tax').value = item.v.toFixed(2);
                            list.classList.add('hidden');
                            app.calc.update();
                            app.saveDraft();
                            app.toast.show(`Località impostata: ${item.l}`, 'success');
                        };
                        list.appendChild(div);
                    });
                }, 300)
            },

            // Calculator Engine
            calc: {
                getVal: (id) => {
                    const el = document.getElementById(id);
                    return el ? parseFloat(el.value) || 0 : 0;
                },

                format: (n) => {
                    return new Intl.NumberFormat('it-IT', {
                        style: 'currency',
                        currency: 'EUR',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(n);
                },

                formatPercent: (n) => {
                    return new Intl.NumberFormat('it-IT', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    }).format(n) + '%';
                },

                setTax: (rate, btn) => {
                    document.getElementById('tax-rate').value = rate;
                    document.querySelectorAll('.btn-tax').forEach(b => {
                        b.classList.remove('active');
                        b.style.background = 'transparent';
                        b.style.borderColor = 'transparent';
                        b.style.color = 'var(--text-muted)';
                    });
                    btn.classList.add('active');
                    btn.style.background = 'var(--primary)';
                    btn.style.borderColor = 'var(--primary)';
                    btn.style.color = '#020617';
                    app.calc.update();
                    app.saveDraft();
                },

                highlightCustomTax: () => {
                    document.querySelectorAll('.btn-tax').forEach(b => {
                        b.classList.remove('active');
                        b.style.background = 'transparent';
                        b.style.borderColor = 'transparent';
                        b.style.color = 'var(--text-muted)';
                    });
                },

                update: () => {
                    const c = app.calc;
                    const mode = app.state.get('mode');
                    
                    // Common values
                    const price = c.getVal('price');
                    const reno = c.getVal('reno');
                    const closing = c.getVal('closing');
                    const ltv = c.getVal('ltv');
                    const rate = c.getVal('rate');
                    const years = c.getVal('years');
                    
                    const totalInvestment = price + reno + closing;
                    const loanAmount = price * (ltv / 100);
                    const equity = totalInvestment - loanAmount;
                    
                    // Mortgage calculation
                    const months = years * 12;
                    const monthlyRate = (rate / 100) / 12;
                    let monthlyPayment = 0;
                    
                    if (loanAmount > 0 && months > 0) {
                        if (monthlyRate > 0) {
                            monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, months)) / 
                                           (Math.pow(1 + monthlyRate, months) - 1);
                        } else {
                            monthlyPayment = loanAmount / months;
                        }
                    }
                    
                    const totalInterest = (monthlyPayment * months) - loanAmount;
                    
                    // Update common UI
                    document.getElementById('res-mortgage').textContent = c.format(monthlyPayment);
                    document.getElementById('res-downpayment').textContent = c.format(equity);
                    document.getElementById('res-total-interest').textContent = c.format(totalInterest);
                    
                    // Update quick stats
                    document.getElementById('quick-total-invest').textContent = c.format(totalInvestment);
                    
                    if (mode === 'rent') {
                        // Rental calculations
                        const adr = c.getVal('adr');
                        const occ = c.getVal('occ') / 100;
                        const portalComm = c.getVal('portal-comm') / 100;
                        const taxRate = c.getVal('tax-rate') / 100;
                        const varCosts = c.getVal('var-costs');
                        const cityTax = c.getVal('city-tax');
                        const fixedCosts = c.getVal('fixed-costs');
                        
                        const annualRevenue = adr * 365 * occ;
                        const portalCosts = annualRevenue * portalComm;
                        const taxableIncome = annualRevenue - portalCosts;
                        const taxAmount = taxableIncome * taxRate;
                        const variableCosts = (varCosts + cityTax) * 365 * occ;
                        const annualFixed = fixedCosts * 12;
                        
                        const mol = annualRevenue - portalCosts - taxAmount - variableCosts - annualFixed;
                        const molMonthly = mol / 12;
                        const netPerNight = occ > 0 ? mol / (365 * occ) : 0;
                        const cashflow = molMonthly - monthlyPayment;
                        
                        // ROI calculation
                        const roi = equity > 0 ? (mol / equity) * 100 : 0;
                        const breakEven = mol > 0 ? Math.ceil(equity / mol) : 0;
                        
                        // Update UI
                        document.getElementById('res-net-night').textContent = c.format(netPerNight);
                        document.getElementById('res-mol-month').textContent = c.format(molMonthly);
                        document.getElementById('res-cashflow').textContent = c.format(cashflow);
                        document.getElementById('quick-roi').textContent = c.formatPercent(roi);
                        document.getElementById('quick-cashflow').textContent = c.format(cashflow);
                        document.getElementById('quick-breakeven').textContent = breakEven > 0 ? `${breakEven} anni` : 'N/A';
                        
                        // Update chart
                        if (app.state.get('charts.profit')) {
                            app.state.get('charts.profit').data.datasets[0].data = [
                                Math.max(0, mol),
                                portalCosts,
                                taxAmount,
                                variableCosts + annualFixed
                            ];
                            app.state.get('charts.profit').update();
                        }
                        
                        // Sensitivity analysis
                        [50, 65, 85].forEach(scenarioOcc => {
                            const sOcc = scenarioOcc / 100;
                            const sRev = adr * 365 * sOcc;
                            const sPortal = sRev * portalComm;
                            const sTax = (sRev - sPortal) * taxRate;
                            const sVar = (varCosts + cityTax) * 365 * sOcc;
                            const sProfit = sRev - sPortal - sTax - sVar - annualFixed;
                            
                            const el = document.getElementById(`sens-${scenarioOcc}`);
                            if (el) {
                                el.textContent = c.format(sProfit);
                                el.style.color = sProfit > 0 ? 'var(--primary)' : 'var(--danger)';
                            }
                        });
                        
                        // Update projection chart
                        app.chart.updateProjection(loanAmount, totalInvestment, rate, months, c.getVal('appreciation') || 2);
                        
                    } else {
                        // Flip calculations
                        const resalePrice = c.getVal('resale-price');
                        const flipMonths = c.getVal('flip-months');
                        const flipAgency = c.getVal('flip-agency') / 100;
                        const flipHolding = c.getVal('flip-holding-extra');
                        const flipTax = c.getVal('flip-tax') / 100;
                        
                        const agencyFee = resalePrice * flipAgency;
                        const holdingCosts = (monthlyPayment * flipMonths) + (flipHolding * flipMonths);
                        const totalCosts = totalInvestment + holdingCosts + agencyFee;
                        const grossProfit = resalePrice - totalCosts;
                        const taxAmount = grossProfit > 0 ? grossProfit * flipTax : 0;
                        const netProfit = grossProfit - taxAmount;
                        const roi = equity > 0 ? (netProfit / equity) * 100 : 0;
                        
                        document.getElementById('res-flip-profit').textContent = c.format(netProfit);
                        document.getElementById('res-flip-roi').textContent = c.formatPercent(roi);
                        document.getElementById('res-holding-costs').textContent = c.format(holdingCosts);
                        document.getElementById('quick-roi').textContent = c.formatPercent(roi);
                        document.getElementById('quick-cashflow').textContent = c.format(netProfit);
                        document.getElementById('quick-breakeven').textContent = 'N/A';
                        
                        // Update chart for flip
                        if (app.state.get('charts.profit')) {
                            app.state.get('charts.profit').data.datasets[0].data = [
                                Math.max(0, netProfit),
                                taxAmount,
                                agencyFee,
                                totalInvestment + holdingCosts
                            ];
                            app.state.get('charts.profit').update();
                        }
                    }
                },

                showAmortization: () => {
                    const c = app.calc;
                    const loan = c.getVal('price') * (c.getVal('ltv') / 100);
                    const rate = c.getVal('rate');
                    const years = c.getVal('years');
                    
                    if (loan <= 0 || years <= 0) {
                        app.toast.show('Inserire valori validi per il mutuo', 'error');
                        return;
                    }
                    
                    const monthlyRate = (rate / 100) / 12;
                    const months = years * 12;
                    const payment = monthlyRate > 0 ?
                        loan * (monthlyRate * Math.pow(1 + monthlyRate, months)) / 
                        (Math.pow(1 + monthlyRate, months) - 1) : loan / months;
                    
                    let balance = loan;
                    let yearlyInterest = 0;
                    let yearlyPrincipal = 0;
                    let html = '';
                    
                    for (let i = 1; i <= months; i++) {
                        const interest = balance * monthlyRate;
                        const principal = payment - interest;
                        balance -= principal;
                        yearlyInterest += interest;
                        yearlyPrincipal += principal;
                        
                        if (i % 12 === 0 || i === months) {
                            const year = Math.ceil(i / 12);
                            const displayBalance = Math.max(0, balance);
                            html += `
                                <tr style="border-bottom: 1px solid var(--border); transition: background 0.2s;" onmouseenter="this.style.background='rgba(255,255,255,0.03)'" onmouseleave="this.style.background='transparent'">
                                    <td style="padding: 1rem; font-weight: 700; color: var(--primary);">Anno ${year}</td>
                                    <td style="padding: 1rem; text-align: right; font-variant-numeric: tabular-nums;">${c.format(yearlyInterest)}</td>
                                    <td style="padding: 1rem; text-align: right; font-variant-numeric: tabular-nums;">${c.format(yearlyPrincipal)}</td>
                                    <td style="padding: 1rem; text-align: right; font-variant-numeric: tabular-nums; font-weight: 600;">${c.format(displayBalance)}</td>
                                </tr>
                            `;
                            yearlyInterest = 0;
                            yearlyPrincipal = 0;
                        }
                    }
                    
                    document.getElementById('amortization-body').innerHTML = html;
                    app.ui.openModal('modal-amortization');
                }
            },

            // Chart Management
            chart: {
                init: () => {
                    const ctx1 = document.getElementById('profitChart').getContext('2d');
                    const profitChart = new Chart(ctx1, {
                        type: 'doughnut',
                        data: {
                            labels: ['Utile Netto', 'Commissioni OTA', 'Tasse', 'Costi Operativi'],
                            datasets: [{
                                data: [0, 0, 0, 0],
                                backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#3b82f6'],
                                borderWidth: 0,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '75%',
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: 'var(--text-muted)',
                                        font: { family: 'Inter', size: 12, weight: '600' },
                                        padding: 20,
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'var(--bg-card)',
                                    titleColor: 'var(--text-main)',
                                    bodyColor: 'var(--text-main)',
                                    borderColor: 'var(--border)',
                                    borderWidth: 1,
                                    padding: 12,
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return `${label}: ${app.calc.format(value)} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    app.state.set('charts.profit', profitChart);
                    
                    // Initialize projection chart
                    const ctx2 = document.getElementById('projectionChart').getContext('2d');
                    const projChart = new Chart(ctx2, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [
                                {
                                    label: 'Valore Immobile',
                                    data: [],
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    fill: true,
                                    tension: 0.4,
                                    borderWidth: 3
                                },
                                {
                                    label: 'Debito Residuo',
                                    data: [],
                                    borderColor: '#ef4444',
                                    borderDash: [5, 5],
                                    fill: false,
                                    tension: 0.4,
                                    borderWidth: 2
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            scales: {
                                x: {
                                    grid: { color: 'var(--border)', drawBorder: false },
                                    ticks: { color: 'var(--text-muted)', font: { family: 'Inter' } }
                                },
                                y: {
                                    grid: { color: 'var(--border)', drawBorder: false },
                                    ticks: {
                                        color: 'var(--text-muted)',
                                        font: { family: 'Inter' },
                                        callback: function(value) {
                                            return '€' + (value / 1000).toFixed(0) + 'k';
                                        }
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: 'var(--text-muted)',
                                        font: { family: 'Inter', weight: '600' },
                                        usePointStyle: true,
                                        padding: 20
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'var(--bg-card)',
                                    titleColor: 'var(--text-main)',
                                    bodyColor: 'var(--text-main)',
                                    borderColor: 'var(--border)',
                                    borderWidth: 1,
                                    padding: 12,
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + app.calc.format(context.parsed.y);
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    app.state.set('charts.projection', projChart);
                },

                switch: (type) => {
                    document.querySelectorAll('.chart-toggle').forEach(btn => {
                        btn.classList.remove('active');
                        btn.style.color = 'var(--text-muted)';
                        btn.style.borderBottomColor = 'transparent';
                    });
                    
                    const activeBtn = document.getElementById(`btn-chart-${type}`);
                    activeBtn.classList.add('active');
                    activeBtn.style.color = 'var(--text-main)';
                    activeBtn.style.borderBottomColor = 'var(--primary)';
                    
                    document.getElementById('view-profit').classList.toggle('hidden', type !== 'profit');
                    document.getElementById('view-proj').classList.toggle('hidden', type !== 'proj');
                    document.getElementById('appreciation-control').style.display = type === 'proj' ? 'block' : 'none';
                },

                updateProjection: (loanAmount, startValue, rate, months, appreciationRate = 2) => {
                    const chart = app.state.get('charts.projection');
                    if (!chart) return;
                    
                    const years = Math.ceil(months / 12);
                    const labels = Array.from({length: years + 1}, (_, i) => `Anno ${i}`);
                    const debtData = [loanAmount];
                    const valueData = [startValue];
                    
                    let balance = loanAmount;
                    let currentValue = startValue;
                    const monthlyRate = (rate / 100) / 12;
                    const payment = monthlyRate > 0 ?
                        loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, months)) / 
                        (Math.pow(1 + monthlyRate, months) - 1) : loanAmount / months;
                    
                    for (let y = 1; y <= years; y++) {
                        for (let m = 0; m < 12; m++) {
                            if (balance > 0.01) {
                                const interest = balance * monthlyRate;
                                const principal = payment - interest;
                                balance = Math.max(0, balance - principal);
                            }
                        }
                        debtData.push(balance);
                        currentValue = currentValue * (1 + (appreciationRate / 100));
                        valueData.push(currentValue);
                    }
                    
                    chart.data.labels = labels;
                    chart.data.datasets[0].data = valueData;
                    chart.data.datasets[1].data = debtData;
                    chart.update();
                }
            },

            // Data Persistence
            saveDraft: debounce(() => {
                const data = {
                    inputs: {},
                    mode: app.state.get('mode'),
                    timestamp: new Date().toISOString()
                };
                
                document.querySelectorAll('input').forEach(input => {
                    if (input.id) data.inputs[input.id] = input.value;
                });
                
                localStorage.setItem('investpro_draft_v2', JSON.stringify(data));
            }, 500),

            restoreDraft: () => {
                try {
                    const draft = localStorage.getItem('investpro_draft_v2');
                    if (draft) {
                        const data = JSON.parse(draft);
                        
                        if (data.inputs) {
                            Object.entries(data.inputs).forEach(([id, value]) => {
                                const el = document.getElementById(id);
                                if (el) el.value = value;
                            });
                        }
                        
                        if (data.mode) {
                            app.mode.set(data.mode);
                        }
                        
                        // Restore tax button state
                        const taxRate = document.getElementById('tax-rate')?.value;
                        if (taxRate) {
                            const btn = document.querySelector(`.btn-tax[data-tax="${taxRate}"]`);
                            if (btn) app.calc.setTax(parseFloat(taxRate), btn);
                        }
                    }
                } catch (e) {
                    console.error('Error restoring draft:', e);
                }
            },

            // Deals Management
            deals: {
                save: async () => {
                    const user = app.state.get('user');
                    if (!user) {
                        app.ui.openModal('modal-login');
                        return;
                    }
                    
                    const projectName = document.getElementById('project-name').value || 'Progetto senza nome';
                    const data = {
                        uid: user.uid,
                        name: projectName,
                        mode: app.state.get('mode'),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        inputs: {}
                    };
                    
                    document.querySelectorAll('input').forEach(input => {
                        if (input.id) data.inputs[input.id] = input.value;
                    });
                    
                    try {
                        if (app.state.get('currentDocId')) {
                            await app.services.db.collection('projects').doc(app.state.get('currentDocId')).update(data);
                            app.toast.show('Progetto aggiornato', 'success');
                        } else {
                            const doc = await app.services.db.collection('projects').add(data);
                            app.state.set('currentDocId', doc.id);
                            app.toast.show('Progetto salvato', 'success');
                        }
                    } catch (error) {
                        app.toast.show('Errore salvataggio', 'error');
                    }
                },

                openManager: async () => {
                    const user = app.state.get('user');
                    if (!user) {
                        app.ui.openModal('modal-login');
                        return;
                    }
                    
                    app.ui.openModal('modal-deals');
                    const container = document.getElementById('deals-list');
                    container.innerHTML = '<div style="text-align: center; padding: 3rem; color: var(--text-muted);"><i class="fa-solid fa-circle-notch fa-spin fa-2x"></i><p style="margin-top: 1rem;">Caricamento...</p></div>';
                    
                    try {
                        const snapshot = await app.services.db.collection('projects')
                            .where('uid', '==', user.uid)
                            .orderBy('updatedAt', 'desc')
                            .get();
                        
                        if (snapshot.empty) {
                            container.innerHTML = '<div style="text-align: center; padding: 3rem; color: var(--text-muted);"><i class="fa-solid fa-folder-open fa-2x" style="margin-bottom: 1rem; opacity: 0.5;"></i><p>Nessun progetto salvato</p></div>';
                            return;
                        }
                        
                        container.innerHTML = '';
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            const date = data.updatedAt?.toDate ? data.updatedAt.toDate().toLocaleDateString('it-IT') : 'Data sconosciuta';
                            const modeIcon = data.mode === 'rent' ? 'fa-house-chimney' : 'fa-handshake';
                            const modeLabel = data.mode === 'rent' ? 'Rental' : 'Trading';
                            
                            const item = document.createElement('div');
                            item.style.cssText = 'background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center;';
                            item.innerHTML = `
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div style="width: 40px; height: 40px; background: var(--bg-body); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fa-solid ${modeIcon}" style="color: var(--primary);"></i>
                                    </div>
                                    <div>
                                        <div style="font-weight: 700; color: var(--text-main); margin-bottom: 0.25rem;">${data.name}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted);">${modeLabel} • ${date}</div>
                                    </div>
                                </div>
                                <i class="fa-solid fa-chevron-right" style="color: var(--text-muted);"></i>
                            `;
                            
                            item.onmouseenter = () => {
                                item.style.background = 'rgba(255,255,255,0.06)';
                                item.style.borderColor = 'var(--primary)';
                                item.style.transform = 'translateX(5px)';
                            };
                            item.onmouseleave = () => {
                                item.style.background = 'rgba(255,255,255,0.03)';
                                item.style.borderColor = 'var(--border)';
                                item.style.transform = 'translateX(0)';
                            };
                            
                            item.onclick = () => {
                                if (data.inputs) {
                                    Object.entries(data.inputs).forEach(([id, value]) => {
                                        const el = document.getElementById(id);
                                        if (el) el.value = value;
                                    });
                                }
                                if (data.mode) app.mode.set(data.mode);
                                app.state.set('currentDocId', doc.id);
                                document.getElementById('project-name').value = data.name;
                                app.calc.update();
                                app.ui.closeModal('modal-deals');
                                app.toast.show('Progetto caricato', 'success');
                            };
                            
                            container.appendChild(item);
                        });
                        
                    } catch (error) {
                        container.innerHTML = '<div style="text-align: center; padding: 3rem; color: var(--danger);">Errore caricamento dati</div>';
                    }
                }
            },

            // Export Functionality
            export: {
                init: () => {
                    // Libraries loaded on demand
                },

                pdf: async () => {
                    await app.loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
                    await app.loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
                    
                    app.toast.show('Generazione PDF in corso...', 'info');
                    
                    try {
                        const element = document.getElementById('main-container');
                        const canvas = await html2canvas(element, {
                            scale: 2,
                            useCORS: true,
                            backgroundColor: app.state.get('theme') === 'dark' ? '#0f172a' : '#ffffff'
                        });
                        
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        const imgData = canvas.toDataURL('image/png');
                        
                        const pageWidth = pdf.internal.pageSize.getWidth();
                        const pageHeight = pdf.internal.pageSize.getHeight();
                        const imgWidth = pageWidth - 20;
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        
                        // Header
                        pdf.setFillColor(16, 185, 129);
                        pdf.rect(0, 0, pageWidth, 25, 'F');
                        pdf.setTextColor(255, 255, 255);
                        pdf.setFontSize(20);
                        pdf.setFont('helvetica', 'bold');
                        pdf.text('INVESTPRO REPORT', 10, 17);
                        pdf.setFontSize(10);
                        pdf.setFont('helvetica', 'normal');
                        pdf.text(`Generato il: ${new Date().toLocaleDateString('it-IT')}`, pageWidth - 10, 17, { align: 'right' });
                        
                        // Content
                        let position = 35;
                        if (imgHeight > pageHeight - 40) {
                            let heightLeft = imgHeight;
                            let page = 0;
                            
                            while (heightLeft > 0) {
                                if (page > 0) pdf.addPage();
                                pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                                heightLeft -= (pageHeight - 50);
                                position = -heightLeft + 35;
                                page++;
                            }
                        } else {
                            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                        }
                        
                        pdf.save(`InvestPro_Report_${document.getElementById('project-name').value.replace(/\s+/g, '_')}.pdf`);
                        app.toast.show('PDF scaricato con successo', 'success');
                        
                    } catch (error) {
                        console.error('PDF export error:', error);
                        app.toast.show('Errore esportazione PDF', 'error');
                    }
                },

                excel: () => {
                    const mode = app.state.get('mode');
                    const c = app.calc;
                    
                    let csvContent = '\uFEFF'; // BOM for Excel UTF-8
                    
                    // Header
                    csvContent += 'INVESTPRO - REPORT ANALISI\n';
                    csvContent += `Progetto:;${document.getElementById('project-name').value}\n`;
                    csvContent += `Data:;${new Date().toLocaleDateString('it-IT')}\n`;
                    csvContent += `Modalità:;${mode === 'rent' ? 'Messa a Reddito' : 'Trading/Flip'}\n\n`;
                    
                    // Property data
                    csvContent += 'DATI IMMOBILE\n';
                    csvContent += `Prezzo Acquisto;${c.getVal('price')} €\n`;
                    csvContent += `Ristrutturazione;${c.getVal('reno')} €\n`;
                    csvContent += `Oneri Notarili;${c.getVal('closing')} €\n`;
                    csvContent += `Località;${document.getElementById('geo-search').value}\n\n`;
                    
                    if (mode === 'rent') {
                        csvContent += 'PARAMETRI RENTAL\n';
                        csvContent += `ADR Medio;${c.getVal('adr')} €\n`;
                        csvContent += `Occupazione;${c.getVal('occ')} %\n`;
                        csvContent += `Commissioni OTA;${c.getVal('portal-comm')} %\n`;
                        csvContent += `Aliquota Fiscale;${c.getVal('tax-rate')} %\n`;
                        csvContent += `Costi Fissi Mensili;${c.getVal('fixed-costs')} €\n\n`;
                        
                        csvContent += 'RISULTATI\n';
                        csvContent += `MOL Mensile;${document.getElementById('res-mol-month').textContent}\n`;
                        csvContent += `Cashflow Post-Debito;${document.getElementById('res-cashflow').textContent}\n`;
                        csvContent += `Utile per Notte;${document.getElementById('res-net-night').textContent}\n`;
                    } else {
                        csvContent += 'PARAMETRI TRADING\n';
                        csvContent += `Prezzo Rivendita;${c.getVal('resale-price')} €\n`;
                        csvContent += `Durata Operazione;${c.getVal('flip-months')} mesi\n`;
                        csvContent += `Commissioni Agenzia;${c.getVal('flip-agency')} %\n\n`;
                        
                        csvContent += 'RISULTATI\n';
                        csvContent += `Utile Netto;${document.getElementById('res-flip-profit').textContent}\n`;
                        csvContent += `ROI;${document.getElementById('res-flip-roi').textContent}\n`;
                    }
                    
                    // Financial structure
                    csvContent += '\nSTRUTTURA FINANZIARIA\n';
                    csvContent += `LTV;${c.getVal('ltv')} %\n`;
                    csvContent += `Tasso Interesse;${c.getVal('rate')} %\n`;
                    csvContent += `Durata;${c.getVal('years')} anni\n`;
                    csvContent += `Rata Mensile;${document.getElementById('res-mortgage').textContent}\n`;
                    
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `InvestPro_${document.getElementById('project-name').value.replace(/\s+/g, '_')}.csv`;
                    link.click();
                    
                    app.toast.show('File Excel (CSV) scaricato', 'success');
                }
            },

            // Upgrade/Payment
            upgrade: {
                showModal: () => {
                    app.ui.openModal('modal-upgrade');
                },
                
                purchase: () => {
                    window.open(CONFIG.stripeLink, '_blank');
                    app.ui.closeModal('modal-upgrade');
                    app.toast.show('Reindirizzamento al pagamento...', 'info');
                }
            },

            // Scenario Comparison
            scenarios: {
                compare: () => {
                    const section = document.getElementById('scenario-comparison');
                    const content = document.getElementById('scenario-content');
                    
                    // Generate comparison table
                    const c = app.calc;
                    const currentMode = app.state.get('mode');
                    
                    let html = '<table style="width: 100%; border-collapse: collapse;">';
                    html += '<thead><tr style="border-bottom: 2px solid var(--border);">';
                    html += '<th style="text-align: left; padding: 1rem; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">Scenario</th>';
                    html += '<th style="text-align: right; padding: 1rem; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">Investimento</th>';
                    html += '<th style="text-align: right; padding: 1rem; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">Ritorno Annuo</th>';
                    html += '<th style="text-align: right; padding: 1rem; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">ROI</th>';
                    html += '<th style="text-align: right; padding: 1rem; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">Cashflow</th>';
                    html += '</tr></thead><tbody>';
                    
                    // Current scenario
                    const price = c.getVal('price');
                    const equity = (price * (1 - c.getVal('ltv')/100)) + c.getVal('reno') + c.getVal('closing');
                    
                    if (currentMode === 'rent') {
                        const mol = parseFloat(document.getElementById('res-mol-month').textContent.replace(/[^\d,-]/g, '').replace(',', '.')) * 12;
                        const cashflow = parseFloat(document.getElementById('res-cashflow').textContent.replace(/[^\d,-]/g, '').replace(',', '.')) * 12;
                        const roi = equity > 0 ? (mol / equity) * 100 : 0;
                        
                        html += `<tr style="border-bottom: 1px solid var(--border); background: rgba(16, 185, 129, 0.05);">`;
                        html += `<td style="padding: 1rem; font-weight: 700; color: var(--primary);"><i class="fa-solid fa-star" style="margin-right: 0.5rem;"></i>Configurazione Attuale</td>`;
                        html += `<td style="padding: 1rem; text-align: right; font-variant-numeric: tabular-nums;">${c.format(equity)}</td>`;
                        html += `<td style="padding: 1rem; text-align: right; font-variant-numeric: tabular-nums;">${c.format(mol)}</td>`;
                        html += `<td style="padding: 1rem; text-align: right; font-variant-numeric: tabular-nums; color: var(--primary); font-weight: 700;">${roi.toFixed(2)}%</td>`;
                        html += `<td style="padding: 1rem; text-align: right; font-variant-numeric: tabular-nums; color: ${cashflow >= 0 ? 'var(--primary)' : 'var(--danger)'}; font-weight: 700;">${c.format(cashflow)}</td>`;
                        html += '</tr>';
                        
                        // Alternative scenarios
                        [60, 80].forEach(occ => {
                            const adr = c.getVal('adr');
                            const annualRev = adr * 365 * (occ/100);
                            const costs = annualRev * 0.4; // Simplified
                            const altMol = annualRev - costs;
                            const altRoi = equity > 0 ? (altMol / equity) * 100 : 0;
                            
                            html += `<tr style="border-bottom: 1px solid var(--border);">`;
                            html += `<td style="padding: 1rem; color: var(--text-muted);">Occupazione ${occ}%</td>`;
                            html += `<td style="padding: 1rem; text-align: right; font-variant-numeric: tabular-nums; color: var(--text-muted);">${c.format(equity)}</td>`;
                            html += `<td style="padding: 1rem; text-align: right; font-variant-numeric: tabular-nums; color: var(--text-muted);">${c.format(altMol)}</td>`;
                            html += `<td style="padding: 1rem; text-align: right; font-variant-numeric: tabular-nums; color: ${altRoi > roi ? 'var(--primary)' : 'var(--text-muted)'};">${altRoi.toFixed(2)}%</td>`;
                            html += `<td style="padding: 1rem; text-align: right; font-variant-numeric: tabular-nums; color: var(--text-muted);">--</td>`;
                            html += '</tr>';
                        });
                    }
                    
                    html += '</tbody></table>';
                    content.innerHTML = html;
                    section.classList.remove('hidden');
                    section.scrollIntoView({ behavior: 'smooth' });
                },
                
                close: () => {
                    document.getElementById('scenario-comparison').classList.add('hidden');
                }
            },

            // Admin Functions
            admin: {
                openConsole: () => {
                    app.toast.show('Admin console non implementata in questa versione', 'info');
                }
            },

            // Theme toggle
            toggleTheme: () => {
                app.state.toggleTheme();
            },

            // Navigation
            navigate: (page) => {
                // SPA routing placeholder
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        // Utility: Debounce
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize app when DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', app.init);
        } else {
            app.init();
        }

        // Service Worker registration for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
                self.addEventListener('install', e => self.skipWaiting());
                self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));
                self.addEventListener('fetch', e => e.respondWith(fetch(e.request).catch(() => caches.match(e.request))));
            `)).catch(() => {});
        }
    </script>
</body>
</html>
